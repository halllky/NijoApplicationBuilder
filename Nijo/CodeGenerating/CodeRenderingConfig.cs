using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Xml;
using System.Xml.Linq;

namespace Nijo.CodeGenerating {
    /// <summary>
    /// スキーマ定義で設定できるアプリケーション単位のソースコードレンダリング設定。
    /// publicなプロパティにはDescription属性をつけ、そのプロパティの役割を1行で記述すること。
    /// ここでつけられた文言はnijo.xml記載ルールのドキュメントにそのまま表れる。
    /// </summary>
    public class CodeRenderingConfig {

        internal const string ROOT_ELEMENT_NAME = "NijoApplicationBuilder";

        /// <summary>
        /// アプリケーションの新規作成時はXMLのルート要素に一切の属性が付されないXMLを保存すればよいので
        /// このコンストラクタが使われるのは既存のアプリケーションの読み込み時のみ
        /// </summary>
        internal CodeRenderingConfig(XDocument xDocument) {
            _xDocument = xDocument;
        }

        private readonly XDocument _xDocument;

        /// <summary>
        /// ソースコード自動生成されたあとのアプリケーションの名前
        /// </summary>
        [Description("【省略可能】ソースコード自動生成されたあとのアプリケーションの表示用名称。未指定の場合はこのXML要素がアプリケーション名になる。")]
        public string ApplicationName => _xDocument.Root?.Attribute(nameof(ApplicationName))?.Value ?? _xDocument.Root?.Name.LocalName ?? "AutoGeneratedApplication";

        /// <summary>
        /// C#側ソースコードの名前空間
        /// </summary>
        [Description("【省略可能】C#側ソースコードの名前空間。未指定の場合は\"Nijo\"という名前になる")]
        public string RootNamespace => _xDocument.Root?.Attribute(nameof(RootNamespace))?.Value ?? "Nijo";
        /// <summary>
        /// DBコンテキストのクラス名
        /// </summary>
        [Description("【省略可能】Entity Framework Core の DbContextのクラス名")]
        public string DbContextName => _xDocument.Root?.Attribute(nameof(DbContextName))?.Value ?? "MyDbContext";

        /// <summary>DBカラム名（作成者）</summary>
        [Description($"【省略可能】{nameof(Models.DataModel)}から生成されるRDBMS上の各テーブルに付される、そのレコードの新規登録者を表すカラムの物理名")]
        public string CreateUserDbColumnName => _xDocument.Root?.Attribute(nameof(CreateUserDbColumnName))?.Value ?? Models.DataModelModules.EFCoreEntity.CREATE_USER;
        /// <summary>DBカラム名（更新者）</summary>
        [Description($"【省略可能】{nameof(Models.DataModel)}から生成されるRDBMS上の各テーブルに付される、そのレコードの最終更新者を表すカラムの物理名")]
        public string UpdateUserDbColumnName => _xDocument.Root?.Attribute(nameof(UpdateUserDbColumnName))?.Value ?? Models.DataModelModules.EFCoreEntity.UPDATE_USER;
        /// <summary>DBカラム名（作成時刻）</summary>
        [Description($"【省略可能】{nameof(Models.DataModel)}から生成されるRDBMS上の各テーブルに付される、そのレコードの新規登録時刻を表すカラムの物理名")]
        public string CreatedAtDbColumnName => _xDocument.Root?.Attribute(nameof(CreatedAtDbColumnName))?.Value ?? Models.DataModelModules.EFCoreEntity.CREATED_AT;
        /// <summary>DBカラム名（更新時刻）</summary>
        [Description($"【省略可能】 {nameof(Models.DataModel)}から生成されるRDBMS上の各テーブルに付される、そのレコードの最終更新時刻を表すカラムの物理名")]
        public string UpdatedAtDbColumnName => _xDocument.Root?.Attribute(nameof(UpdatedAtDbColumnName))?.Value ?? Models.DataModelModules.EFCoreEntity.UPDATED_AT;
        /// <summary>DBカラム名（楽観排他用バージョン）</summary>
        [Description($"【省略可能】 {nameof(Models.DataModel)}から生成されるRDBMS上の集約ルートテーブルに付される、楽観排他制御用のバージョンのカラムの物理名")]
        public string VersionDbColumnName => _xDocument.Root?.Attribute(nameof(VersionDbColumnName))?.Value ?? Models.DataModelModules.EFCoreEntity.VERSION;

        /// <summary>
        /// 開発環境におけるReact.jsのサーバーが展開されるURL。httpから始める必要あり。
        /// ASP.NET Core サーバーでのCORS設定に必要。
        /// </summary>
        [Description($"【廃止予定】開発環境におけるReact.jsのサーバーが展開されるURL。ASP.NET Core サーバーでのCORS設定に必要")]
        public string ReactDebuggingUrl => _xDocument.Root?.Attribute(nameof(ReactDebuggingUrl))?.Value ?? "http://localhost:5173";
        /// <summary>
        /// 開発環境におけるASP.NET Coreのサーバーが展開されるURL。httpsから始める必要あり。
        /// 開発環境でReact.jsがバックエンド側処理を呼ぶのに必要。
        /// </summary>
        [Description($"【廃止予定】開発環境におけるASP.NET Coreのサーバーが展開されるURL。React.jsからのバックエンド呼び出し必要")]
        public string DotnetDebuggingUrl => _xDocument.Root?.Attribute(nameof(DotnetDebuggingUrl))?.Value ?? "https://localhost:7098";

        /// <summary>
        /// このインスタンスの情報を引数のXElementに反映させます。
        /// </summary>
        internal void Save(XElement rootElement) {

            if (!string.IsNullOrWhiteSpace(RootNamespace)) {
                rootElement.SetAttributeValue(nameof(RootNamespace), RootNamespace);
            }
        }
    }
}

# 不変スキーマモデル

このフォルダには、スキーマ解析が完了して妥当性が検証された後の、不変なスキーマモデルの定義が含まれています。

## 目的と背景

XMLスキーマ定義の解析処理では、不正なスキーマ定義の存在によりエラーが発生する可能性があります。しかし、コード生成処理では確実に動作することが要求されます。

そこで、スキーマ解析とコード生成の間に「検証済み不変スキーマモデル」の層を設けることで：

- **スキーマ解析処理**: エラーハンドリングに注力し、不正な定義を検出・排除
- **コード生成処理**: 例外処理を気にせず、確実にソースコードを生成

という責任分離を実現しています。

## 主な責務

1. **不変性の保証**: 一度作成されたスキーマモデルは変更されません。各ソースコードのレンダリングは並列で実行され、実行されるたびに実行順序が変わりますが、スキーマモデルが不変であることにより、問題なく記述することができます。
2. **妥当性の保証**: このモデルに含まれるデータは全て検証済みです
3. **コード生成API**: コード生成処理で必要な情報を安定したAPIで提供します
4. **スキーマ関係性の表現**: 集約間の親子関係・参照関係を正確に表現します

## 設計の特徴

### 不変性の実現
- 全てのプロパティは読み取り専用
- オブジェクト作成後の状態変更は不可能
- スレッドセーフな実装

### パス表現による関係性管理
XMLの階層構造を保持したまま、集約やメンバーへの参照を効率的に管理しています。これにより循環参照がある場合でも正しく処理できます。

### コード生成特化設計
UI表示名、データベース物理名、C#/TypeScript型名など、コード生成で必要となる各種名称を体系的に管理しています。

## 主要な構成要素と役割

### ApplicationSchema
アプリケーション全体のスキーマ定義のエントリーポイント。XMLドキュメントからルート集約を列挙し、スキーマ全体の情報にアクセスするためのAPIを提供します。

### スキーマの構成要素
大きく分けて集約と集約メンバーから成る。

#### **AggregateBase**: 集約
集約メンバーを保有するコンテナ。

- **RootAggregate**: ルート集約（アプリケーションの主要エンティティ）
- **ChildAggregate**: 単一子集約。「親 : 子 = 1 : (0 or 1)」の多重度を持つ子集約
- **ChildrenAggregate**: 配列子集約。「親 : 子 = 1 : N」の多重度を持つ子集約

#### **IAggregateMember**: 集約のメンバー
集約に保有される項目。

- **ValueMember**: 単一値メンバー（ID、名前、日付等）。種類を表すインターフェースが **IValueMemberType**
- **IRelationalMember**: 子集約や参照先集約を持つメンバーのインターフェース
  - **ChildAggregate**: 前述の通り
  - **ChildrenAggregate**: 前述の通り
  - **RefToMember**: 他の集約への外部参照メンバー

## 他の機能との関係
- [SchemaParsing](../SchemaParsing/README.md): 不変スキーマの前工程。
  - **スキーマ解析・検証処理**: 生XMLやパース中間状態を扱う
  - **エラー報告処理**: 不正なスキーマ定義に対するエラーメッセージ生成
  - **スキーマ定義の変更処理**: 元のXMLドキュメントを直接操作する

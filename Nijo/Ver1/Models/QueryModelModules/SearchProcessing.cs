using Nijo.Util.DotnetEx;
using Nijo.Ver1.CodeGenerating;
using Nijo.Ver1.ImmutableSchema;
using Nijo.Ver1.Parts.Common;
using Nijo.Ver1.Parts.CSharp;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace Nijo.Ver1.Models.QueryModelModules {
    /// <summary>
    /// 検索処理
    /// </summary>
    internal class SearchProcessing {

        internal SearchProcessing(RootAggregate rootAggregate) {
            _rootAggregate = rootAggregate;
        }
        private readonly RootAggregate _rootAggregate;

        internal string ReactHookName => $"use{_rootAggregate.PhysicalName}Loader";
        internal string ReactHookReturnTypeName => $"Use{_rootAggregate.PhysicalName}LoaderReturn";

        private const string CONTROLLER_ACTION_LOAD = "load";
        internal string ActionEndpoint => $"{CONTROLLER_ACTION_LOAD}";

        private const string VALIDATE_METHOD = "ValidateSearchCondition";
        private const string LOAD_METHOD = "LoadAsync";

        internal const string CREATE_QUERY_SOURCE = "CreateQuerySource";
        internal const string APPEND_WHERE_CLAUSE = "AppendWhereClause";
        internal const string APPEND_ORDERBY_CLAUSE = "AppendOrderByClause";
        private const string ON_AFTER_LOADED = "OnAfterLoaded";
        private const string TO_DISPLAY_DATA = "ToDisplayData";
        private const string SET_KEYS_READONLY = "SetKeysReadOnly";


        #region TypeScript用
        internal static string RenderTsTypeMap(IEnumerable<RootAggregate> queryModels) {

            var items = queryModels.Select(rootAggregate => {
                var controller = new AspNetController(rootAggregate);
                var searchCondition = new SearchCondition(rootAggregate);
                var displayData = new DisplayData(rootAggregate);

                return new {
                    EscapedPhysicalName = rootAggregate.PhysicalName.Replace("'", "\\'"),
                    Endpoint = controller.GetActionNameForClient(CONTROLLER_ACTION_LOAD),
                    ParamType = searchCondition.TsTypeName,
                    ReturnType = $"Util.{SearchProcessingReturn.TYPE_TS}<{displayData.TsTypeName}>",
                };
            }).ToArray();

            return $$"""
                /** 一覧検索処理 */
                export namespace LoadFeature {
                  /** 一覧検索処理のURLエンドポイントの一覧 */
                  export const Endpoint: { [key in {{CommandQueryMappings.QUERY_MODEL_TYPE}}]: string } = {
                {{items.SelectTextTemplate(x => $$"""
                    '{{x.EscapedPhysicalName}}': '{{x.Endpoint}}',
                """)}}
                  }

                  /** 一覧検索処理のパラメータ型の一覧 */
                  export interface ParamType {
                {{items.SelectTextTemplate(x => $$"""
                    '{{x.EscapedPhysicalName}}': {{x.ParamType}}
                """)}}
                  }

                  /** 一覧検索処理の処理結果の型の一覧 */
                  export interface ReturnType {
                {{items.SelectTextTemplate(x => $$"""
                    '{{x.EscapedPhysicalName}}': {{x.ReturnType}}
                """)}}
                  }
                }
                """;
        }
        #endregion TypeScript用

        internal string RenderAspNetCoreControllerAction(CodeRenderingContext ctx) {
            var searchCondition = new SearchCondition(_rootAggregate);
            var searchConditionMessages = new SearchConditionMessageContainer(_rootAggregate);

            return $$"""
                /// <summary>
                /// {{_rootAggregate.DisplayName}}の一覧検索処理のエンドポイント
                /// </summary>
                [HttpPost("{{CONTROLLER_ACTION_LOAD}}"), {{AspNetController.AUTOGENERATED_ENDPOINT}}({{CommandQueryMappings.E_COMMAND_QUERY_TYPE}}.{{_rootAggregate.PhysicalName}}, {{E_AutoGeneratedActionType.ENUM_NAME}}.{{E_AutoGeneratedActionType.READ}})]
                public async Task<IActionResult> Load({{searchCondition.CsClassName}} {{AspNetController.DATA}}, {{PresentationContext.INTERFACE}}<{{searchConditionMessages.CsClassName}}> {{AspNetController.CONTEXT}}) {
                    // エラーチェック
                    _applicationService.{{VALIDATE_METHOD}}(data, context);
                    if (context.Messages.HasError() || (!context.Options.IgnoreConfirm && context.HasConfirm())) {
                        return _webConfigure.{{AspNetController.TO_ACTION_RESULT}}(null, context);
                    }

                    // 検索処理実行
                    var returnValue = await _applicationService.{{LOAD_METHOD}}(data, context);
                    return _webConfigure.{{AspNetController.TO_ACTION_RESULT}}(returnValue, context);
                }
                """;
        }

        internal string RenderAppSrvMethods(CodeRenderingContext ctx) {
            var searchCondition = new SearchCondition(_rootAggregate);
            var searchConditionMessage = new SearchConditionMessageContainer(_rootAggregate);
            var searchResult = new SearchResult(_rootAggregate);
            var displayData = new DisplayData(_rootAggregate);

            return $$"""
                #region 検索
                /// <summary>
                /// {{_rootAggregate.DisplayName}}の検索条件の内容を検証します。
                /// 不正な場合、検索処理自体の実行が中止されます。
                /// </summary>
                /// <param name="searchCondition">検索条件</param>
                /// <param name="context">エラーがある場合はこのオブジェクトの中にエラー内容を追記してください。</param>
                public virtual void {{VALIDATE_METHOD}}({{searchCondition.CsClassName}} searchCondition, {{PresentationContext.INTERFACE}}<{{searchConditionMessage.CsClassName}}> context) {
                    // エラーチェックがある場合はこのメソッドをオーバーライドして記述してください。
                }

                /// <summary>
                /// {{_rootAggregate.DisplayName}}の一覧検索を行ないます。
                /// </summary>
                public async Task<{{SearchProcessingReturn.TYPE_CS}}<{{displayData.CsClassName}}>> {{LOAD_METHOD}}({{searchCondition.CsClassName}} searchCondition, {{PresentationContext.INTERFACE}}<{{searchConditionMessage.CsClassName}}> context) {
                    // FROM句, SELECT句
                    var querySource = {{CREATE_QUERY_SOURCE}}(searchCondition, context);

                    // 絞り込み(WHERE句)
                    var filtered = {{APPEND_WHERE_CLAUSE}}(querySource, searchCondition);

                    // 並び替え(ORDER BY 句)
                    var sorted = {{APPEND_ORDERBY_CLAUSE}}(filtered, searchCondition);

                    // ページング(SKIP, TAKE)
                    var query = sorted;
                    if (searchCondition.{{SearchCondition.SKIP_CS}} != null) {
                        query = query.Skip(searchCondition.{{SearchCondition.SKIP_CS}}.Value);
                    }
                    if (searchCondition.{{SearchCondition.TAKE_CS}} != null) {
                        query = query.Take(searchCondition.{{SearchCondition.TAKE_CS}}.Value);
                    }

                    // 画面表示用の型への変換
                    var converted = query.Select({{TO_DISPLAY_DATA}}());

                    // 検索処理実行
                    {{displayData.CsClassName}}[] loaded;
                    int totalCount;
                    try {
                        var countTask = filtered.CountAsync();
                        var searchTask = converted.ToArrayAsync();

                        // UIのパフォーマンスのため並列で実行
                        await Task.WhenAll(countTask, searchTask);

                        loaded = await searchTask;
                        totalCount = await countTask;
                    } catch {
                        Log.Debug("{{_rootAggregate.DisplayName.Replace("\"", "\\\"")}} エラー発生時検索条件: {0}", searchCondition.ToJson());
                        try {
                            Log.Debug("{{_rootAggregate.DisplayName.Replace("\"", "\\\"")}} エラー発生時SQL: {0}", query.ToQueryString());
                        } catch {
                            Log.Debug("{{_rootAggregate.DisplayName.Replace("\"", "\\\"")}} 不具合調査用のSQL変換に失敗しました。");
                        }
                        throw;
                    }

                    // 読み取り専用項目の設定や、C#上での追加情報の付加など、任意のカスタマイズ処理
                    var currentPageItems = {{ON_AFTER_LOADED}}(loaded, searchCondition, context).ToArray();

                    // 主キー項目を読み取り専用にする。UI上で主キーが変更されるとあらゆる処理がうまくいかなくなる
                    foreach (var displayData in currentPageItems) {
                        {{SET_KEYS_READONLY}}(displayData);
                    }

                    return new() {
                        {{SearchProcessingReturn.CURRENT_PAGE_ITEMS_CS}} = currentPageItems,
                        {{SearchProcessingReturn.TOTAL_COUNT_CS}} = totalCount,
                    };
                }
                /// <summary>
                /// {{_rootAggregate.DisplayName}}のデータベースへの問い合わせデータ構造（SQLで言うSELECT句とFROM句）を定義する
                /// </summary>
                protected abstract IQueryable<{{searchResult.CsClassName}}> {{CREATE_QUERY_SOURCE}}({{searchCondition.CsClassName}} searchCondition, {{PresentationContext.INTERFACE}}<{{searchConditionMessage.CsClassName}}> context);
                {{RenderAppendWhereClause(ctx)}}
                {{RenderAppendOrderByClause()}}
                {{RenderToDisplayData()}}
                /// <summary>
                /// {{_rootAggregate.DisplayName}}の一覧検索の読み込み後処理
                /// </summary>
                protected virtual IEnumerable<{{displayData.CsClassName}}> {{ON_AFTER_LOADED}}(IEnumerable<{{displayData.CsClassName}}> currentPageItems, {{searchCondition.CsClassName}} searchCondition, {{PresentationContext.INTERFACE}}<{{searchConditionMessage.CsClassName}}> context) {
                    // 読み込み後処理がある場合はここで実装してください。
                    return currentPageItems;
                }
                /// <summary>
                /// {{_rootAggregate.DisplayName}}の画面表示データの主キー項目を読み取り専用にする
                /// </summary>
                protected virtual void {{SET_KEYS_READONLY}}({{displayData.CsClassName}} displayData) {
                    // TODO ver.1
                }
                #endregion 検索
                """;
        }

        /// <summary>
        /// WHERE句
        /// </summary>
        private string RenderAppendWhereClause(CodeRenderingContext ctx) {
            var searchCondition = new SearchCondition(_rootAggregate);
            var searchResult = new SearchResult(_rootAggregate);

            return $$"""
                /// <summary>
                /// {{_rootAggregate.DisplayName}}のクエリに画面で指定された検索条件（SQLで言うWHERE句）を付加する
                /// </summary>
                protected virtual IQueryable<{{searchResult.CsClassName}}> {{APPEND_WHERE_CLAUSE}}(IQueryable<{{searchResult.CsClassName}}> query, {{searchCondition.CsClassName}} searchCondition) {
                {{searchCondition.FilterRoot.GetValueMembersRecursively().SelectTextTemplate(vm => $$"""
                    // 絞り込み: {{vm.DisplayName}}
                    {{WithIndent(vm.Type.SearchBehavior!.RenderFiltering(new() { Member = vm, Query = "query", SearchCondition = "searchCondition", CodeRenderingContext = ctx }), "    ")}}

                """)}}
                    return query;
                }
                """;
        }

        /// <summary>
        /// ORDER BY 句
        /// </summary>
        private string RenderAppendOrderByClause() {
            var searchCondition = new SearchCondition(_rootAggregate);
            var searchResult = new SearchResult(_rootAggregate);

            var sortMembers = searchCondition
                .EnumerateSortMembersRecursively()
                .Select(m => {
                    var literal = m.GetLiteral();
                    return new {
                        AscLiteral = literal + SearchCondition.ASC_SUFFIX,
                        DescLiteral = literal + SearchCondition.DESC_SUFFIX,
                        Path = m.Member.GetPathFromEntry().AsSearchResult().Join("!."),
                    };
                })
                .ToArray();

            return $$"""
                /// <summary>
                /// {{_rootAggregate.DisplayName}}のクエリに画面で指定された並び順指定（SQLで言うORDER BY句）を付加する
                /// </summary>
                protected virtual IQueryable<{{searchResult.CsClassName}}> {{APPEND_ORDERBY_CLAUSE}}(IQueryable<{{searchResult.CsClassName}}> query, {{searchCondition.CsClassName}} searchCondition) {
                    IOrderedQueryable<{{searchResult.CsClassName}}>? sorted = null;
                    foreach (var sortOption in searchCondition.{{SearchCondition.SORT_CS}}) {
                        sorted = sortOption switch {
                {{sortMembers.SelectTextTemplate(m => $$"""
                            "{{m.AscLiteral}}" => sorted == null
                                ? query.OrderBy(e => e.{{m.Path}})
                                : sorted.ThenBy(e => e.{{m.Path}}),
                            "{{m.DescLiteral}}" => sorted == null
                                ? query.OrderByDescending(e => e.{{m.Path}})
                                : sorted.ThenByDescending(e => e.{{m.Path}}),
                """)}}
                            _ => throw new InvalidOperationException($"ソート条件 '{sortOption}' が不正です。"),
                        };
                    }
                    return sorted ?? query;
                }
                """;
        }

        /// <summary>
        /// ToDisplayData
        /// </summary>
        private string RenderToDisplayData() {
            var searchResult = new SearchResult(_rootAggregate);
            var displayData = new DisplayData(_rootAggregate);

            return $$"""
                /// <summary>
                /// {{_rootAggregate.DisplayName}}の検索結果型を画面表示用の型に変換する式を返します。
                /// 検索条件には存在するが画面表示用データには存在しない項目は、この式の結果に含まれません。
                /// </summary>
                protected virtual Expression<Func<{{searchResult.CsClassName}}, {{displayData.CsClassName}}>> {{TO_DISPLAY_DATA}}() {
                    return searchResult => new {{displayData.CsClassName}}() {
                        {{DisplayData.VALUES_CS}} = new() {
                {{displayData.GetOwnMembers().SelectTextTemplate(member => $$"""
                            {{WithIndent(RenderMember(member), "            ")}}
                """)}}
                        },
                {{If(displayData.HasLifeCycle, () => $$"""
                        {{DisplayData.EXISTS_IN_DB_CS}} = true,
                        {{DisplayData.WILL_BE_CHANGED_CS}} = false,
                        {{DisplayData.WILL_BE_DELETED_CS}} = false,
                """)}}
                {{If(displayData.HasVersion, () => $$"""
                        {{DisplayData.VERSION_CS}} = searchResult.{{SearchResult.VERSION}},
                """)}}
                    };
                }
                """;

            static string RenderMember(DisplayData.DisplayDataMember member) {
                if (member is DisplayData.DisplayDataValueMember vm) {
                    return $$"""
                        {{member.PhysicalName}} = searchResult.{{vm.Member.GetPathFromEntry().AsSearchResult().Join("!.")}},
                        """;

                }
                if (member is DisplayData.DisplayDataRefMember refTo) {
                    return $$"""
                        {{member.PhysicalName}} = new() {
                        {{refTo.GetMembers().SelectTextTemplate(m => $$"""

                        """)}}
                            {{WithIndent(RenderMember(member), "    ")}}
                        },
                        """;
                }
                throw new NotImplementedException();
            }
        }
    }
}

using Microsoft.Extensions.Logging;
using Nijo.Ver1.CodeGenerating;
using Nijo.Ver1.ImmutableSchema;
using Nijo.Ver1.SchemaParsing;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Xml.Linq;

namespace Nijo.Ver1 {
    /// <summary>
    /// 自動生成されるプロジェクトに対する操作を提供します。
    /// </summary>
    public class GeneratedProject {

        private const string XML_FILENAME = "nijo.xml";

        internal GeneratedProject(string projectRoot, ILogger logger) {
            ProjectRoot = projectRoot;
            _logger = logger;
        }

        private readonly ILogger _logger;

        public string ProjectRoot { get; }

        public string CoreLibrary => Path.Combine(ProjectRoot, "core.AutoGenerated");
        public string CoreLibraryOverride => Path.Combine(ProjectRoot, "core");
        public string WebapiProject => Path.Combine(ProjectRoot, "webapi");
        public string ReactProject => Path.Combine(ProjectRoot, "react");

        /// <summary>
        /// このプロジェクトのソースコード自動生成設定を返します。
        /// </summary>
        public ApplicationConfig GetConfig() {
            var xDocument = XDocument.Load(Path.Combine(ProjectRoot, XML_FILENAME));
            return new ApplicationConfig(xDocument);
        }

        /// <summary>
        /// コード自動生成を実行します。
        /// </summary>
        internal void GenerateCode() {
            // スキーマ定義の解釈ルールを決定
            var xmlParseContext = SchemaParseContext.Default();

            // スキーマ定義のコレクションを作成
            var xDocument = XDocument.Load(Path.Combine(ProjectRoot, XML_FILENAME));
            if (!ApplicationSchema.TryBuild(xDocument, xmlParseContext, out var immutableSchema, out var errors)) {
                _logger.LogError("エラーがある状態でソースコードの自動生成を行なうことはできません。");
                foreach (var err in errors) _logger.LogError("- {error}", err);
                return;
            }

            var ctx = new CodeRenderingContext(this, GetConfig(), xmlParseContext);
            var appearedModels = new HashSet<IModel>(); // 一度でも登場したモデル

            _logger.LogInformation("ソース自動生成開始");

            // ルート集約毎のコードを生成
            foreach (var rootAggregate in immutableSchema.GetRootAggregates()) {
                _logger.LogInformation("レンダリング開始: {name}", rootAggregate.DisplayName);
                var model = rootAggregate.Model;
                appearedModels.Add(model);
                model.GenerateCode(ctx, rootAggregate);
            }

            // ルート集約と対応しないコードを生成
            foreach (var model in appearedModels) {
                _logger.LogInformation("レンダリング開始: {name}", model.GetType().Name);
                model.GenerateCode(ctx);
            }

            // IMultiAggregateSourceFile が別の IMultiAggregateSourceFile に依存することがあるので、
            // すべて漏らさず確実に依存関係を登録させる。
            // ソース自動生成中で一度でも登場した IMultiAggregateSourceFile それぞれ必ず1回ずつ依存関係登録メソッドを呼ぶ
            var handled = new HashSet<IMultiAggregateSourceFile>();
            while (true) {
                var appeared = ctx.GetMultiAggregateSourceFiles();
                var unhandled = appeared.Where(src => !handled.Contains(src)).ToArray();

                if (unhandled.Length == 0) {
                    break; // 全ての IMultiAggregateSourceFile の依存関係登録メソッドが呼ばれたら終了
                }
                foreach (var src in unhandled) {
                    src.RegisterDependencies(ctx);
                    handled.Add(src);
                }
            }

            // 以降は IMultiAggregateSourceFile の新規登録不可
            ctx.StopUseMultiAggregateSourceFiles();

            // IMultiAggregateSourceFile のレンダリング実行
            foreach (var src in ctx.GetMultiAggregateSourceFiles()) {
                _logger.LogInformation("レンダリング開始: {name}", src.GetType().Name);
                src.Render(ctx);
            }

            // スキーマ定義にかかわらず必ず生成されるモジュールを生成する
            ctx.CoreLibrary(autoGenerated => {
                autoGenerated.Directory("Util", dir => {
                    dir.Generate(Parts.Core.PresentationContext.RenderInterface());
                });
            });
            ctx.ReactProject(autoGenerated => {
                autoGenerated.Directory("util", dir => {
                    dir.Generate(Models.QueryModelModules.UiConstraint.RenderCommonConstraint());
                });
            });

            // 生成されていないファイルやディレクトリを削除
            ctx.CleanUnhandledFilesAndDirectories();

            _logger.LogInformation("ソース自動生成終了");
        }
    }
}

using Microsoft.Extensions.DependencyInjection;
using MyApp.Core;
using MyApp.Test;

namespace MyApp;

public static class TestUtilBuilder {

    public static TestUtilImpl Build() {
        return new TestUtilImpl();
    }
}

/// <summary>
/// <see cref="ITestUtil"/> の実装
/// </summary>
public class TestUtilImpl : ITestUtil {

    public ITestScope<MessageContainer> CreateScope(IPresentationContextOptions? options = null) {
        return CreateScope<MessageContainer>(options);
    }
    public ITestScope<TMessageRoot> CreateScope<TMessageRoot>(IPresentationContextOptions? options = null) where TMessageRoot : IMessageContainer {
        // DI機構
        var configure = new OverridedApplicationConfigure();
        var services = new ServiceCollection();
        configure.ConfigureServices(services);

        // PresentationContext
        var provider = services.BuildServiceProvider();
        var messageRoot = MessageContainer.GetDefaultClass<TMessageRoot>([]);
        var contextOptions = options ?? new PresentationContextOptionsImpl();
        var presentationContext = new PresentationContextInUnitTest<TMessageRoot>(messageRoot, contextOptions);

        return new TestScopeImpl<TMessageRoot>(provider, presentationContext);
    }

    public void Dispose() {
        // 特に後処理なし
    }

    #region
    private class PresentationContextOptionsImpl : IPresentationContextOptions {
        public bool IgnoreConfirm { get; init; }
    }
    #endregion
}

/// <summary>
/// <see cref="ITestScope{TMessageRoot}"/> の実装
/// </summary>
public class TestScopeImpl<TMessage> : ITestScope<TMessage> where TMessage : IMessageContainer {
    internal TestScopeImpl(IServiceProvider serviceProvider, IPresentationContext<TMessage> presentationContext) {
        ServiceProvider = serviceProvider;
        App = serviceProvider.GetRequiredService<OverridedApplicationService>();
        PresentationContext = presentationContext;
    }
    public IServiceProvider ServiceProvider { get; }
    public OverridedApplicationService App { get; }
    public IPresentationContext<TMessage> PresentationContext { get; }

    AutoGeneratedApplicationService ITestScope<TMessage>.App => App;

    void IDisposable.Dispose() {
        // 特に後処理なし
    }
}

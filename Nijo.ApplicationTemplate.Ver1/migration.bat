chcp 65001 
@rem ↑dotnetコマンド実行時に強制的に書き換えられてしまいnpmの標準入出力が化けるので先に書き換えておく 
 
@echo off 
setlocal 
 
@rem マイグレーションのバージョン指定 
set /p "MIGRATION_VERSION=作成するマイグレーションバージョンを指定してください: " 
 
if "%MIGRATION_VERSION%"=="" ( 
  @echo 処理を中断します。 
  exit /b 
) 
 
@rem ソースコードの最新化 
call .\run-nijo-exe.bat generate 
 
set "TARGET_PROJECT=--project .\Core.AutoGenerated --startup-project .\Core" 
 
@rem DB定義の変更があるかどうか確認 
dotnet ef migrations has-pending-model-changes %TARGET_PROJECT% 
 
if "%errorlevel%"=="0" ( 
  @echo 変更なしのため処理終了 
  exit /b 
) 
if "%errorlevel%"=="1" ( 
  @echo 変更ありのためマイグレーション作成 
) else ( 
  @echo has-pending-model-changes が想定外の結果を返しました: %errorlevel% 
  exit /b 
) 
 
@rem マイグレーションの起点（ひとつ前のバージョン）を探す 
set "PREVIOUS_VERSION=" 
for /F %%i in ('dotnet ef migrations list --no-build %TARGET_PROJECT%') do @set "PREVIOUS_VERSION=%%i" 
 
if "%PREVIOUS_VERSION%"=="No" ( 
  set "PREVIOUS_VERSION=" 
) 
 
@rem マイグレーションの追加 
dotnet ef migrations add %MIGRATION_VERSION% --no-build --context MyDbContext %TARGET_PROJECT% 
 
if not "%errorlevel%"=="0" ( 
  exit /b 
) 
 
@echo マイグレーション処理をカスタマイズする場合、Up / Down に処理を追加してください。 
pause 
 
@rem SQLスクリプトの作成 
dotnet ef migrations script %PREVIOUS_VERSION% --output Core.AutoGenerated\MigrationsScript\%MIGRATION_VERSION%.sql %TARGET_PROJECT% 
 
import * as ReactHookForm from "react-hook-form"
import { RouteObjectWithSideMenuSetting } from "../routes"
import * as AutoGenerated from "../__autoGenerated"
import { getSchema } from "./getSchema"
import { MultiView } from "./MultiView"
import { SingleView } from "./SingleView"

/**
 * 自動生成されたメタデータを用いて既定の画面を作成し、
 * それらをルーティング設定に変換して返す。
 */
export const getReflectionPages = (): RouteObjectWithSideMenuSetting[] => {
  const schema = getSchema()
  return Object.entries(schema.metadata).flatMap(([rootAggregatePhysicalName, structureMetadata]) => {

    // ルート集約と対応する一覧検索画面
    const multiView = (
      <MultiView
        key={rootAggregatePhysicalName}
        rootAggregatePhysicalName={rootAggregatePhysicalName}
        metadata={structureMetadata}
        schema={schema}
      />
    )

    // ルート集約と対応する詳細画面
    const singleView = (
      <SingleView
        key={rootAggregatePhysicalName}
        rootAggregatePhysicalName={rootAggregatePhysicalName as AutoGenerated.QueryModelType}
        metadata={structureMetadata}
        schema={schema}
      />
    )

    // 編集モードのキー
    const keys = schema.getSingleViewUrlKeyNames(structureMetadata)

    return [{
      // 一覧検索画面
      path: `${rootAggregatePhysicalName}`,
      sideMenuLabel: structureMetadata.displayName,
      element: multiView,
    }, {
      // 詳細編集画面（新規モード: "new"、編集モード: "detail"）
      path: `${rootAggregatePhysicalName}/:mode/${keys.map(key => `:${key}?`).join('/')}`,
      element: singleView,
    }]
  })
}

import * as React from "react"
import * as ReactRouter from "react-router-dom"
import * as ReactHookForm from "react-hook-form"
import * as Layout from "../layout"
import * as Input from "../input"
import { MetadataForPage } from "../__autoGenerated/util"
import useEvent from "react-use-event-hook"
import { Panel, PanelGroup, PanelResizeHandle } from "react-resizable-panels"
import { ReflectionForm } from "./Parts.Form"
import { useReflectionGridColumnDefs } from "./Parts.Grid"
import { MetadataSchema } from "./getSchema"

/** QueryModelの一覧検索画面 */
export const MultiView = ({ rootAggregatePhysicalName, metadata, schema }: {
  rootAggregatePhysicalName: string
  metadata: MetadataForPage.StructureMetadata
  schema: MetadataSchema
}) => {

  // 検索条件
  const form = ReactHookForm.useForm()

  // 検索結果
  const [currentPageItems, setCurrentPageItems] = React.useState<ReactHookForm.FieldValues[]>([])
  const getColumnDefs = useReflectionGridColumnDefs(metadata, schema)

  // 新規登録画面へ遷移する
  const navigate = ReactRouter.useNavigate()
  const handleNavigateNew = useEvent(() => {
    navigate(`/${rootAggregatePhysicalName}/new`)
  })

  return (
    <Layout.PageFrame
      headerContent={(
        <>
          <Layout.PageFrameTitle>
            {metadata.displayName}
          </Layout.PageFrameTitle>
          <div className="flex-1"></div>
          {!metadata.isReadOnly && (
            <Input.IconButton onClick={handleNavigateNew}>新規</Input.IconButton>
          )}
        </>
      )}
    >
      <PanelGroup direction="vertical">
        <Panel collapsible minSize={8}>
          <div className="h-full overflow-y-auto p-4">
            <ReflectionForm metadata={metadata} schema={schema} formMethods={form} />
          </div>
        </Panel>

        <PanelResizeHandle className="h-1 bg-gray-300" />

        <Panel>
          <Layout.EditableGrid
            rows={currentPageItems}
            getColumnDefs={getColumnDefs}
            className="h-full"
          />
        </Panel>
      </PanelGroup>
    </Layout.PageFrame>
  )
}



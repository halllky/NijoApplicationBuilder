import React from "react"
import * as ReactHookForm from "react-hook-form"
import * as ReactRouter from "react-router-dom"
import { UUID } from "uuidjs"
import * as Input from "../../__autoGenerated/input"
import { ApplicationData, QueryModel定義, 属性種類定義 } from "../types"
import { Outliner, PageFrame, DataTable2, useColumnDef, MarkdownTextarea, SectionTitle } from "../ui-components"
import { SingleLineTextBox } from "../ui-components/SingleLineTextBox"

export default function () {
  const { key0 } = ReactRouter.useParams()
  const form = ReactHookForm.useFormContext<ApplicationData>()
  const commandModels = ReactHookForm.useFieldArray({ name: 'QueryModel定義', control: form.control })
  const [index, model] = React.useMemo(() => {
    const ix = commandModels.fields.findIndex(model => model.uniqueId === key0)
    return ix === -1
      ? [undefined, undefined]
      : [ix, commandModels.fields[ix]]
  }, [key0, commandModels])

  return (
    <PageFrame title={model?.表示名}>
      {index === undefined ? (
        <span>読み込み中...</span>
      ) : (
        <AfterLoaded index={index} rhfMethods={form} />
      )}
    </PageFrame>
  )
}

const AfterLoaded = ({ index, rhfMethods: { control } }: {
  index: number
  rhfMethods: ReactHookForm.UseFormReturn<ApplicationData>
}) => {

  const displayName = ReactHookForm.useController({ name: `QueryModel定義.${index}.表示名`, control })
  const latinName = ReactHookForm.useController({ name: `QueryModel定義.${index}.ラテン名`, control })
  const performance = ReactHookForm.useController({ name: `QueryModel定義.${index}.パフォーマンス要件定義`, control })
  const defaultSort = ReactHookForm.useController({ name: `QueryModel定義.${index}.既定のソート順`, control })
  const isReadOnlyModel = ReactHookForm.useController({ name: `QueryModel定義.${index}.読み取り専用集約`, control })

  // 項目定義
  const membersColumns = useColumnDef<ReactHookForm.FieldArrayWithId<ApplicationData, `QueryModel定義.${number}.項目定義`>>(({ text, memberType }) => [
    text({ id: '00', getValue: row => row.表示名, setValue: (r, v) => r.表示名 = v }),
    memberType({ id: '01', header: '種類', getValue: r => r.属性種類UniqueId, setValue: (r, v) => r.属性種類UniqueId = v }),
  ])
  const createNewMember = React.useCallback((): ReactHookForm.FieldArrayWithId<ApplicationData, `QueryModel定義.${number}.項目定義`> => ({
    id: UUID.generate(),
    uniqueId: UUID.generate(),
    データソース定義: {},
    属性項目定義に依らない特記事項: {},
    属性種類ごとの定義: {},
  }), [])


  return (
    <div className="grid grid-cols-[14rem,1fr] gap-y-2">

      <SectionTitle>表示名</SectionTitle>
      <SingleLineTextBox {...displayName.field} placeholder="表示名を記載してください" />

      <SectionTitle>ラテン名</SectionTitle>
      <SingleLineTextBox {...latinName.field} placeholder="ラテン名を記載してください" />

      <SectionTitle>読み取り専用集約</SectionTitle>
      <div>
        <Input.CheckBox {...isReadOnlyModel.field} />
      </div>

      <SectionTitle>パフォーマンス要件定義</SectionTitle>
      <MarkdownTextarea {...performance.field} placeholder="パフォーマンス要件定義を記載してください" />

      <SectionTitle>既定のソート順</SectionTitle>
      <MarkdownTextarea {...defaultSort.field} placeholder="既定のソート順を記載してください" />

      <DataTable2
        title="項目定義"
        name={`QueryModel定義.${index}.項目定義`}
        columns={membersColumns}
        createNewItem={createNewMember}
        control={control}
        className="col-span-full"
      />
    </div>
  )
}
